<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMD Timeline - GoMikroBot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .glass {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(48, 54, 61, 0.5);
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #30363d;
            transform: translateX(-50%);
            z-index: -1;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #58a6ff;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">
    <div id="app" class="flex flex-col h-full">
        <!-- Header -->
        <header class="glass p-4 flex justify-between items-center z-10 shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full animate-pulse" :class="silentMode ? 'bg-yellow-500' : 'bg-green-500'">
                </div>
                <h1 class="text-xl font-bold text-white tracking-widest">QMD <span class="text-blue-400">MEMORY</span>
                </h1>

                <!-- Silent Mode Toggle -->
                <div class="flex items-center gap-2 ml-4 px-3 py-1.5 rounded-lg border transition-all duration-300"
                    :class="silentMode ? 'bg-yellow-900/30 border-yellow-700' : 'bg-green-900/20 border-green-800'">
                    <span class="text-[10px] uppercase font-bold tracking-wider"
                        :class="silentMode ? 'text-yellow-400' : 'text-green-400'">
                        {{ silentMode ? 'üîá SILENT' : 'üîä LIVE' }}
                    </span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" v-model="silentMode" @change="toggleSilent" class="sr-only peer">
                        <div class="w-9 h-5 rounded-full peer transition-colors duration-300"
                            :class="silentMode ? 'bg-yellow-600' : 'bg-green-600'">
                            <div class="absolute top-[2px] left-[2px] w-4 h-4 bg-white rounded-full transition-transform duration-300"
                                :class="silentMode ? 'translate-x-4' : ''"></div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="flex gap-4 items-center">
                <label class="text-xs text-gray-500 uppercase">Focus:</label>
                <select v-model="selectedUser"
                    class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 text-white">
                    <option value="">ALL TIMELINES</option>
                    <option v-for="user in senders" :key="user" :value="user">{{ user }}</option>
                </select>

                <!-- Authorization Filter -->
                <label class="text-xs text-gray-500 uppercase ml-4">Filter:</label>
                <select v-model="authFilter"
                    class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 text-white">
                    <option value="all">All Messages</option>
                    <option value="authorized">‚úì Authorized</option>
                    <option value="unauthorized">‚ö†Ô∏è Unauthorized</option>
                </select>

                <button @click="fetchData" class="text-gray-400 hover:text-white ml-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Timeline Container -->
        <main class="flex-1 overflow-y-auto w-full relative p-4" ref="main">
            <div class="timeline-line"></div>

            <div class="max-w-4xl mx-auto space-y-6 relative">

                <div v-for="event in filteredEvents" :key="event.id"
                    class="flex items-start gap-4 transition-all duration-300" :class="{'opacity-30': isDimmed(event)}">
                    <!-- Left Side (Bot / System) -->
                    <div class="flex-1 text-right" v-if="isBot(event)">
                        <div class="inline-block text-left max-w-[90%]">
                            <div class="flex items-center justify-end gap-2 mb-1">
                                <span class="text-xs text-gray-500">{{ formatTime(event.timestamp) }}</span>
                                <span class="text-xs font-bold text-blue-400">AGENT</span>
                            </div>
                            <div class="glass p-3 rounded-l-xl rounded-tr-xl border-l-4 border-l-blue-500">
                                <p class="whitespace-pre-wrap">{{ event.content_text }}</p>
                                <div v-if="event.event_type === 'SYSTEM'"
                                    class="mt-2 text-xs text-yellow-500 border-t border-gray-700 pt-1">
                                    LOG: {{ event.classification }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1" v-else></div>

                    <!-- Center Dot -->
                    <div class="w-4 h-4 rounded-full border-2 border-[#0d1117] z-10 shrink-0 mt-8"
                        :class="getDotClass(event)">
                    </div>

                    <!-- Right Side (User) -->
                    <div class="flex-1 text-left" v-if="!isBot(event)">
                        <div class="inline-block max-w-[90%]">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold"
                                    :class="event.authorized ? 'text-green-400' : 'text-yellow-400'">{{ event.sender_id
                                    }}</span>
                                <span v-if="!event.authorized"
                                    class="text-[9px] px-1.5 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700">‚ö†
                                    UNAUTHORIZED</span>
                                <span class="text-xs text-gray-500">{{ formatTime(event.timestamp) }}</span>
                            </div>
                            <div class="glass p-3 rounded-r-xl rounded-tl-xl border-r-4 border-r-green-500">
                                <!-- Text Content -->
                                <p class="whitespace-pre-wrap" v-if="event.content_text">{{ event.content_text }}</p>

                                <!-- Image Display -->
                                <div v-if="event.media_path && isImage(event.media_path)" class="mt-2">
                                    <img :src="getMediaUrl(event.media_path)"
                                        class="rounded-lg shadow-md max-w-full max-h-64 object-cover border border-gray-700"
                                        alt="User Image">
                                    <div class="text-[10px] text-gray-500 mt-1 truncate max-w-[200px]">{{
                                        event.media_path.split('/').pop() }}</div>
                                </div>

                                <!-- Audio Player -->
                                <div v-if="event.media_path && isAudio(event.media_path)" class="mt-2">
                                    <audio controls class="w-full h-8" :src="getMediaUrl(event.media_path)"></audio>
                                    <div class="text-[10px] text-gray-500 mt-1 truncate max-w-[200px]">{{
                                        event.media_path.split('/').pop() }}</div>
                                </div>

                                <!-- Document Preview -->
                                <div v-if="event.media_path && isDocument(event.media_path)" class="mt-2">
                                    <a :href="getMediaUrl(event.media_path)" target="_blank"
                                        class="flex items-center gap-3 p-3 rounded-lg bg-[#161b22] border border-gray-700 hover:border-blue-500 transition-colors group cursor-pointer no-underline">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg shrink-0"
                                            :class="docIconClass(event.media_path)">
                                            {{ docIcon(event.media_path) }}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div
                                                class="text-sm font-medium text-gray-200 truncate group-hover:text-blue-400 transition-colors">
                                                {{ event.media_path.split('/').pop() }}
                                            </div>
                                            <div class="text-[10px] text-gray-500 flex items-center gap-2 mt-0.5">
                                                <span>{{ docExt(event.media_path).toUpperCase() }}</span>
                                                <span>‚Ä¢</span>
                                                <span>Click to open</span>
                                            </div>
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4 text-gray-500 group-hover:text-blue-400 shrink-0" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                    </a>
                                </div>

                                <!-- Classification Tag -->
                                <div v-if="event.classification"
                                    class="mt-2 text-[10px] inline-block px-2 py-0.5 rounded bg-gray-800 text-gray-300 border border-gray-600">
                                    {{ event.classification }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1" v-else></div>
                </div>

                <div v-if="events.length === 0" class="text-center py-20 text-gray-600">
                    NO MEMORY RECORDS FOUND
                </div>

            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue
        createApp({
            setup() {
                const events = ref([])
                const selectedUser = ref("")
                const authFilter = ref("all")
                const silentMode = ref(true) // Default: safe (silent)

                // Load silent mode from server
                const loadSilentMode = async () => {
                    try {
                        const res = await fetch('/api/v1/settings?key=silent_mode')
                        const data = await res.json()
                        silentMode.value = data.value === '' || data.value === 'true' // default true
                    } catch (e) { console.error('Failed to load silent mode', e) }
                }

                // Toggle and persist
                const toggleSilent = async () => {
                    try {
                        await fetch('/api/v1/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key: 'silent_mode', value: String(silentMode.value) })
                        })
                    } catch (e) { console.error('Failed to save silent mode', e) }
                }

                // Computed unique senders (excluding AGENT/SYSTEM implicitly, usually empty sender or specific ID)
                const senders = computed(() => {
                    const s = new Set(events.value.filter(e => e.event_type !== 'SYSTEM' && !e.event_id.includes('_ACK')).map(e => e.sender_id))
                    return Array.from(s).sort()
                })

                // Determine if event is from Bot
                const isBot = (e) => e.event_type === 'SYSTEM' || e.event_id.endsWith('_ACK')

                // Determine dot color
                const getDotClass = (e) => {
                    if (e.classification === 'EMERGENCY') return 'bg-red-500 shadow-[0_0_10px_red]'
                    if (e.event_type === 'SYSTEM') return 'bg-blue-500'
                    if (!e.authorized) return 'bg-yellow-500' // Unauthorized indicator
                    return 'bg-green-500'
                }

                const fetchData = async () => {
                    try {
                        const res = await fetch('/api/v1/timeline?limit=200')
                        events.value = await res.json() || []
                    } catch (e) {
                        console.error(e)
                    }
                }

                // Filtering opacity logic
                const isDimmed = (e) => {
                    if (!selectedUser.value) return false // No focus -> show all
                    if (isBot(e)) {
                        // If it's a bot message, we need to know who it was replying to.
                        // Currently our schema doesn't strictly link them except via time/context.
                        // For now: Bot messages are always visible (or we could assume the context).
                        // Let's dim "other users" messages.
                        return false
                    }
                    return e.sender_id !== selectedUser.value
                }

                // Filter events based on authorization
                const filteredEvents = computed(() => {
                    return events.value.filter(e => {
                        if (authFilter.value === 'authorized') {
                            return e.authorized === true
                        } else if (authFilter.value === 'unauthorized') {
                            return e.authorized === false
                        }
                        return true // 'all'
                    })
                })

                const formatTime = (ts) => {
                    return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
                }

                const getMediaUrl = (path) => {
                    if (!path) return ""
                    // Helper to convert absolute path to relative URL
                    // Assumes path contains "/media/"
                    if (path.includes('/media/')) {
                        const rel = path.split('/media/')[1]
                        return '/media/' + rel
                    }
                    // Fallback to filename if structure is unknown, but assume audio/
                    return '/media/audio/' + path.split('/').pop()
                }

                const isImage = (path) => {
                    if (!path) return false
                    const ext = path.split('.').pop().toLowerCase()
                    return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)
                }

                const isAudio = (path) => {
                    if (!path) return false
                    const ext = path.split('.').pop().toLowerCase()
                    return ['mp3', 'ogg', 'wav', 'm4a'].includes(ext)
                }

                const isDocument = (path) => {
                    if (!path) return false
                    const ext = path.split('.').pop().toLowerCase()
                    return ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'csv', 'zip', 'bin'].includes(ext)
                }

                const docExt = (path) => {
                    if (!path) return ''
                    return path.split('.').pop().toLowerCase()
                }

                const docIcon = (path) => {
                    const ext = docExt(path)
                    const icons = { pdf: 'üìï', doc: 'üìò', docx: 'üìò', xls: 'üìó', xlsx: 'üìó', ppt: 'üìô', pptx: 'üìô', txt: 'üìÑ', csv: 'üìä', zip: 'üì¶' }
                    return icons[ext] || 'üìé'
                }

                const docIconClass = (path) => {
                    const ext = docExt(path)
                    const classes = { pdf: 'bg-red-900/40 border border-red-800', doc: 'bg-blue-900/40 border border-blue-800', docx: 'bg-blue-900/40 border border-blue-800', xls: 'bg-green-900/40 border border-green-800', xlsx: 'bg-green-900/40 border border-green-800' }
                    return classes[ext] || 'bg-gray-800 border border-gray-700'
                }

                onMounted(() => {
                    fetchData()
                    loadSilentMode()
                    setInterval(fetchData, 5000)
                })

                return { events, filteredEvents, selectedUser, authFilter, silentMode, toggleSilent, senders, isBot, getDotClass, fetchData, formatTime, getMediaUrl, isDimmed, isImage, isAudio, isDocument, docIcon, docIconClass, docExt }
            }
        }).mount('#app')
    </script>
</body>

</html>